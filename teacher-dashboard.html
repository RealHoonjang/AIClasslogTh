<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>êµì‚¬ìš© ëŒ€ì‹œë³´ë“œ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- ì—‘ì…€ ë‹¤ìš´ë¡œë“œë¥¼ ìœ„í•œ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì¶”ê°€ -->
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
</head>
<body>
    <div class="container mt-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>êµì‚¬ìš© ëŒ€ì‹œë³´ë“œ</h2>
            <div class="d-flex align-items-center">
                <div class="me-3">
                    <label class="form-label">ì‹œì‘ì¼:</label>
                    <input type="date" class="form-control" id="startDate">
                </div>
                <div class="me-3">
                    <label class="form-label">ì¢…ë£Œì¼:</label>
                    <input type="date" class="form-control" id="endDate">
                </div>
                <div>
                    <button class="btn btn-success me-2" onclick="downloadExcel()">
                        ì—‘ì…€ ë‹¤ìš´ë¡œë“œ
                    </button>
                    <button class="btn btn-danger" onclick="clearData()">
                        ë°ì´í„° ì´ˆê¸°í™”
                    </button>
                </div>
            </div>
        </div>
        <p id="currentDate" class="text-muted"></p>

        <!-- ì˜¤ëŠ˜ì˜ í†µê³„ -->
        <div class="row mb-4">
            <div class="col-md-4">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">ì²´í¬ì¸ í˜„í™©</h5>
                        <p class="card-text" id="checkinCount">ë¡œë”©ì¤‘...</p>
                    </div>
                </div>
            </div>
            <div class="col-md-8">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">ì˜¤ëŠ˜ì˜ ê°ì • í†µê³„</h5>
                        <canvas id="moodChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- ìƒë‹´ ì‹ ì²­ ëª©ë¡ -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">ìƒë‹´ ì‹ ì²­ í˜„í™©</h5>
            </div>
            <div class="card-body">
                <div id="counselingList"></div>
            </div>
        </div>

        <!-- ì „ì²´ ì²´í¬ì¸ ëª©ë¡ -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">ì˜¤ëŠ˜ì˜ ì²´í¬ì¸ ëª©ë¡</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>í•™ë²ˆ</th>
                                <th>ì´ë¦„</th>
                                <th>ì–´ì œ ê³µë¶€í•œ ë‚´ìš©</th>
                                <th>ê°ì •ìƒíƒœ</th>
                                <th>ì–´ì œ ëª©í‘œ ë‹¬ì„±</th>
                                <th>ì˜¤ëŠ˜ì˜ ëª©í‘œ</th>
                                <th>ì‹œê°„</th>
                            </tr>
                        </thead>
                        <tbody id="checkinList"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- í†µê³„ í•„í„° ì˜ì—­ ì¶”ê°€ -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">ë°ì´í„° í•„í„°</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <label class="form-label">í•™ìƒ ì„ íƒ</label>
                        <select class="form-select" id="studentFilter">
                            <option value="">ì „ì²´ í•™ìƒ</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">ê°ì • ìƒíƒœ</label>
                        <select class="form-select" id="moodFilter">
                            <option value="">ì „ì²´</option>
                            <option value="negative">ë¶€ì •ì  ê°ì • (ë§¤ìš°ë‚˜ì¨, ë‚˜ì¨)</option>
                            <option value="neutral">ë³´í†µ</option>
                            <option value="positive">ê¸ì •ì  ê°ì • (ì¢‹ìŒ, ë§¤ìš°ì¢‹ìŒ)</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">ìƒë‹´ ìš”ì²­</label>
                        <select class="form-select" id="counselingFilter">
                            <option value="">ì „ì²´</option>
                            <option value="true">ìƒë‹´ ìš”ì²­ë§Œ</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">ì •ë ¬ ê¸°ì¤€</label>
                        <select class="form-select" id="sortFilter">
                            <option value="date-desc">ìµœì‹ ìˆœ</option>
                            <option value="date-asc">ì˜¤ë˜ëœìˆœ</option>
                            <option value="mood-asc">ê°ì • ë‚®ì€ìˆœ</option>
                            <option value="mood-desc">ê°ì • ë†’ì€ìˆœ</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <!-- í•™ìƒë³„ ê°ì • ë³€í™” ê·¸ë˜í”„ -->
        <div class="card mb-4" id="studentStatsCard" style="display: none;">
            <div class="card-header">
                <h5 class="mb-0">í•™ìƒë³„ ê°ì • ë³€í™” ì¶”ì´</h5>
            </div>
            <div class="card-body">
                <canvas id="studentMoodChart"></canvas>
            </div>
        </div>

        <!-- ìœ„í—˜ ì‹ í˜¸ ì•Œë¦¼ ì˜ì—­ -->
        <div id="warningAlert" class="alert alert-danger" style="display: none;">
            <h5>âš ï¸ ì£¼ì˜ í•„ìš” í•™ìƒ</h5>
            <div id="warningList"></div>
        </div>
    </div>

    <script>
        // í˜„ì¬ ë‚ ì§œ í‘œì‹œ
        document.getElementById('currentDate').textContent = 
            new Date().toLocaleDateString('ko-KR', { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric', 
                weekday: 'long' 
            });

        // localStorageì—ì„œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
        function getCheckinData() {
            return JSON.parse(localStorage.getItem('checkinData') || '[]');
        }

        // ì˜¤ëŠ˜ ë‚ ì§œì˜ ë°ì´í„°ë§Œ í•„í„°ë§
        function getTodayData() {
            const today = new Date().toISOString().split('T')[0];
            return getCheckinData().filter(data => 
                data.timestamp.startsWith(today)
            );
        }

        // ê°ì • í†µê³„ ì°¨íŠ¸ ìƒì„±
        function createMoodChart(data) {
            const moodCounts = [0, 0, 0, 0, 0];
            
            data.forEach(item => {
                moodCounts[item.mood - 1]++;
            });

            const ctx = document.getElementById('moodChart').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['ë§¤ìš°ë‚˜ì¨', 'ë‚˜ì¨', 'ë³´í†µ', 'ì¢‹ìŒ', 'ë§¤ìš°ì¢‹ìŒ'],
                    datasets: [{
                        label: 'ê°ì • ìƒíƒœ',
                        data: moodCounts,
                        backgroundColor: [
                            '#ff6b6b',  // ë§¤ìš°ë‚˜ì¨ - ë¹¨ê°„ìƒ‰
                            '#ffd93d',  // ë‚˜ì¨ - ë…¸ë€ìƒ‰
                            '#6c757d',  // ë³´í†µ - íšŒìƒ‰
                            '#4dabf7',  // ì¢‹ìŒ - íŒŒë€ìƒ‰
                            '#51cf66'   // ë§¤ìš°ì¢‹ìŒ - ì´ˆë¡ìƒ‰
                        ]
                    }]
                },
                options: {
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        }

        // ìƒë‹´ ì‹ ì²­ ëª©ë¡ í‘œì‹œ
        function displayCounselingRequests(data) {
            const counselingList = document.getElementById('counselingList');
            const counselingRequests = data.filter(item => 
                item.counselingRequest
            );

            if (counselingRequests.length === 0) {
                counselingList.innerHTML = '<p class="text-muted">ì˜¤ëŠ˜ì˜ ìƒë‹´ ì‹ ì²­ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }

            const html = counselingRequests.map(item => `
                <div class="alert alert-info">
                    <h6>${item.studentName} (${item.studentId})</h6>
                    <p class="mb-0">${item.message || 'ë©”ì‹œì§€ ì—†ìŒ'}</p>
                </div>
            `).join('');

            counselingList.innerHTML = html;
        }

        // ì²´í¬ì¸ ëª©ë¡ í‘œì‹œ
        function displayCheckinList(data) {
            const checkinList = document.getElementById('checkinList');
            const moodEmojis = ['ğŸ˜¢', 'ğŸ˜”', 'ğŸ˜', 'ğŸ™‚', 'ğŸ˜Š'];

            const html = data.map(item => `
                <tr>
                    <td>${item.studentId}</td>
                    <td>${item.studentName}</td>
                    <td>${item.studyRecord}</td>
                    <td>${moodEmojis[item.mood - 1]}</td>
                    <td>
                        ${item.yesterdayGoalAchieved === 'true' 
                            ? '<span class="text-success">âœ… ë‹¬ì„±</span>' 
                            : '<span class="text-danger">âŒ ë¯¸ë‹¬ì„±</span>'}
                    </td>
                    <td>${item.todayGoal}</td>
                    <td>${new Date(item.timestamp).toLocaleTimeString()}</td>
                </tr>
            `).join('');

            checkinList.innerHTML = html;
            
            // ì²´í¬ì¸ ìˆ˜ ì—…ë°ì´íŠ¸
            document.getElementById('checkinCount').textContent = 
                `${data.length}ëª… ì²´í¬ì¸ ì™„ë£Œ`;
        }

        // í˜ì´ì§€ ë¡œë“œì‹œ ì‹¤í–‰
        createMoodChart(getTodayData());
        displayCounselingRequests(getTodayData());
        displayCheckinList(getTodayData());

        // 1ë¶„ë§ˆë‹¤ ë°ì´í„° ìƒˆë¡œê³ ì¹¨
        setInterval(() => {
            createMoodChart(getTodayData());
            displayCounselingRequests(getTodayData());
            displayCheckinList(getTodayData());
        }, 60000);

        // í˜ì´ì§€ ë¡œë“œì‹œ ë‚ ì§œ ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', () => {
            const today = new Date().toISOString().split('T')[0];
            const oneMonthAgo = new Date();
            oneMonthAgo.setMonth(oneMonthAgo.getMonth() - 1);
            
            document.getElementById('startDate').value = oneMonthAgo.toISOString().split('T')[0];
            document.getElementById('startDate').max = today;
            
            document.getElementById('endDate').value = today;
            document.getElementById('endDate').max = today;
        });

        // ë‚ ì§œ ë²”ìœ„ì— í•´ë‹¹í•˜ëŠ” ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
        function getDataByDateRange(startDate, endDate) {
            const data = getCheckinData();
            return data.filter(item => {
                const itemDate = item.timestamp.split('T')[0];
                return itemDate >= startDate && itemDate <= endDate;
            });
        }

        // ì—‘ì…€ ë‹¤ìš´ë¡œë“œ í•¨ìˆ˜ ìˆ˜ì •
        function downloadExcel() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;

            if (!startDate || !endDate) {
                alert('ì‹œì‘ì¼ê³¼ ì¢…ë£Œì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }

            const data = getDataByDateRange(startDate, endDate);
            
            if (data.length === 0) {
                alert('ì„ íƒí•œ ê¸°ê°„ì— ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            // ì—‘ì…€ ë°ì´í„° í˜•ì‹ ë³€í™˜
            const excelData = data.map(item => ({
                'ë‚ ì§œ': new Date(item.timestamp).toLocaleDateString(),
                'ì‹œê°„': new Date(item.timestamp).toLocaleTimeString(),
                'í•™ë²ˆ': item.studentId,
                'ì´ë¦„': item.studentName,
                'ì–´ì œ ê³µë¶€í•œ ë‚´ìš©': item.studyRecord,
                'ê°ì •ìƒíƒœ': ['ë§¤ìš°ë‚˜ì¨', 'ë‚˜ì¨', 'ë³´í†µ', 'ì¢‹ìŒ', 'ë§¤ìš°ì¢‹ìŒ'][item.mood - 1],
                'ì–´ì œ ëª©í‘œ ë‹¬ì„±': item.yesterdayGoalAchieved === 'true' ? 'ë‹¬ì„±' : 'ë¯¸ë‹¬ì„±',
                'ì˜¤ëŠ˜ì˜ ëª©í‘œ': item.todayGoal,
                'ìƒë‹´ìš”ì²­': item.counselingRequest ? 'ì˜ˆ' : 'ì•„ë‹ˆì˜¤',
                'ìƒë‹´ë‚´ìš©': item.message || ''
            }));

            // ì—‘ì…€ ì›Œí¬ë¶ ìƒì„±
            const ws = XLSX.utils.json_to_sheet(excelData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "ì²´í¬ì¸ë°ì´í„°");

            // ì—´ ë„ˆë¹„ ìë™ ì¡°ì •
            const maxWidth = excelData.reduce((acc, row) => {
                Object.keys(row).forEach(key => {
                    const length = (row[key] || '').toString().length;
                    acc[key] = Math.max(acc[key] || 0, length);
                });
                return acc;
            }, {});

            ws['!cols'] = Object.keys(maxWidth).map(key => ({
                wch: Math.min(maxWidth[key] + 2, 50) // ìµœëŒ€ 50ìë¡œ ì œí•œ
            }));

            // íŒŒì¼ëª…ì— ë‚ ì§œ ë²”ìœ„ í¬í•¨
            const fileName = `ì²´í¬ì¸_ë°ì´í„°_${startDate}_${endDate}.xlsx`;
            XLSX.writeFile(wb, fileName);
        }

        // ë‚ ì§œ ì…ë ¥ í•„ë“œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        document.getElementById('startDate').addEventListener('change', function() {
            document.getElementById('endDate').min = this.value;
        });

        document.getElementById('endDate').addEventListener('change', function() {
            document.getElementById('startDate').max = this.value;
        });

        // ë°ì´í„° ì´ˆê¸°í™” í•¨ìˆ˜
        function clearData() {
            if (confirm('ì •ë§ ëª¨ë“  ë°ì´í„°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) {
                // ë°ì´í„° ì‚­ì œ ì „ ë°±ì—… íŒŒì¼ ë‹¤ìš´ë¡œë“œ
                downloadExcel();
                
                // localStorage ë°ì´í„° ì‚­ì œ
                localStorage.removeItem('checkinData');
                
                // í™”ë©´ ìƒˆë¡œê³ ì¹¨
                alert('ëª¨ë“  ë°ì´í„°ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.\në°±ì—… íŒŒì¼ì´ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.');
                location.reload();
            }
        }

        // ë°ì´í„° í•„í„°ë§ ê¸°ëŠ¥ ì¶”ê°€
        function addDateFilter() {
            const today = new Date().toISOString().split('T')[0];
            const filterHtml = `
                <div class="mb-3">
                    <label class="form-label">ë‚ ì§œ ì„ íƒ:</label>
                    <input type="date" class="form-control" id="dateFilter" 
                           value="${today}" max="${today}">
                </div>
            `;

            document.querySelector('.container').insertAdjacentHTML('afterbegin', filterHtml);

            // ë‚ ì§œ í•„í„° ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
            document.getElementById('dateFilter').addEventListener('change', (e) => {
                const selectedDate = e.target.value;
                const filteredData = getCheckinData().filter(data => 
                    data.timestamp.startsWith(selectedDate)
                );
                updateDashboard(filteredData);
            });
        }

        // ëŒ€ì‹œë³´ë“œ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        function updateDashboard(data) {
            // ê¸°ì¡´ ì°¨íŠ¸ ì œê±°
            const chartElement = document.getElementById('moodChart');
            if (chartElement) {
                chartElement.remove();
                const newCanvas = document.createElement('canvas');
                newCanvas.id = 'moodChart';
                document.querySelector('.card-body').appendChild(newCanvas);
            }

            // ë°ì´í„°ë¡œ ëŒ€ì‹œë³´ë“œ ì—…ë°ì´íŠ¸
            createMoodChart(data);
            displayCounselingRequests(data);
            displayCheckinList(data);
        }

        // í˜ì´ì§€ ë¡œë“œì‹œ í•„í„° ì¶”ê°€
        addDateFilter();

        // í•™ìƒë³„ í†µê³„ ë° ê·¸ë˜í”„ ê´€ë ¨ í•¨ìˆ˜
        function initializeStudentFilter() {
            const data = getCheckinData();
            const students = [...new Set(data.map(item => 
                JSON.stringify({id: item.studentId, name: item.studentName})
            ))].map(str => JSON.parse(str));

            const select = document.getElementById('studentFilter');
            students.forEach(student => {
                const option = document.createElement('option');
                option.value = student.id;
                option.textContent = `${student.name} (${student.id})`;
                select.appendChild(option);
            });
        }

        function showStudentStats(studentId) {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const data = getDataByDateRange(startDate, endDate);
            const studentData = data.filter(item => item.studentId === studentId);

            if (studentData.length === 0) {
                alert('ì„ íƒí•œ ê¸°ê°„ì— ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            // ê°ì • ë³€í™” ì¶”ì´ ê·¸ë˜í”„
            const moodTrend = studentData.map(item => ({
                date: new Date(item.timestamp).toLocaleDateString(),
                mood: item.mood,
                counseling: item.counselingRequest
            }));

            const ctx = document.getElementById('studentMoodChart').getContext('2d');
            if (window.studentChart) {
                window.studentChart.destroy();
            }

            window.studentChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: moodTrend.map(item => item.date),
                    datasets: [{
                        label: 'ê°ì • ìƒíƒœ',
                        data: moodTrend.map(item => item.mood),
                        borderColor: '#4dabf7',
                        backgroundColor: moodTrend.map(item => 
                            item.counseling ? 'rgba(255, 0, 0, 0.2)' : 'transparent'
                        ),
                        pointStyle: moodTrend.map(item => 
                            item.counseling ? 'star' : 'circle'
                        ),
                        pointRadius: moodTrend.map(item => 
                            item.counseling ? 8 : 5
                        )
                    }]
                },
                options: {
                    scales: {
                        y: {
                            min: 1,
                            max: 5,
                            ticks: {
                                stepSize: 1,
                                callback: function(value) {
                                    return ['ë§¤ìš°ë‚˜ì¨', 'ë‚˜ì¨', 'ë³´í†µ', 'ì¢‹ìŒ', 'ë§¤ìš°ì¢‹ìŒ'][value-1];
                                }
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const item = moodTrend[context.dataIndex];
                                    let label = ['ë§¤ìš°ë‚˜ì¨', 'ë‚˜ì¨', 'ë³´í†µ', 'ì¢‹ìŒ', 'ë§¤ìš°ì¢‹ìŒ'][item.mood-1];
                                    if (item.counseling) {
                                        label += ' (ìƒë‹´ìš”ì²­)';
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            });

            document.getElementById('studentStatsCard').style.display = 'block';
        }

        // ìœ„í—˜ ì‹ í˜¸ ê°ì§€ í•¨ìˆ˜
        function checkWarningSignals() {
            const data = getCheckinData();
            const today = new Date().toISOString().split('T')[0];
            const warningList = [];

            // í•™ìƒë³„ë¡œ ìµœê·¼ ë°ì´í„° ë¶„ì„
            const studentGroups = {};
            data.forEach(item => {
                const date = item.timestamp.split('T')[0];
                if (!studentGroups[item.studentId]) {
                    studentGroups[item.studentId] = [];
                }
                studentGroups[item.studentId].push({
                    date,
                    mood: item.mood,
                    name: item.studentName
                });
            });

            // 3ì¼ ì—°ì† ë§¤ìš° ë‚˜ì¨ ê°ì • ì²´í¬
            Object.entries(studentGroups).forEach(([studentId, checks]) => {
                // ìµœê·¼ 3ì¼ ë°ì´í„°ë§Œ í•„í„°ë§
                const recentChecks = checks
                    .filter(check => {
                        const checkDate = new Date(check.date);
                        const threeDaysAgo = new Date();
                        threeDaysAgo.setDate(threeDaysAgo.getDate() - 2);
                        return checkDate >= threeDaysAgo;
                    })
                    .sort((a, b) => new Date(b.date) - new Date(a.date));

                if (recentChecks.length >= 3 && 
                    recentChecks.every(check => check.mood === 1)) {
                    warningList.push({
                        studentId,
                        studentName: recentChecks[0].name,
                        days: recentChecks.length
                    });
                }
            });

            // ê²½ê³  í‘œì‹œ
            const warningAlert = document.getElementById('warningAlert');
            const warningListElement = document.getElementById('warningList');
            
            if (warningList.length > 0) {
                warningListElement.innerHTML = warningList.map(warning => `
                    <div class="mb-2">
                        <strong>${warning.studentName}</strong> í•™ìƒì´ 
                        ìµœê·¼ ${warning.days}ì¼ ì—°ì† ë§¤ìš° ë‚˜ì¨ ê°ì •ì„ ë³´ì´ê³  ìˆìŠµë‹ˆë‹¤.
                    </div>
                `).join('');
                warningAlert.style.display = 'block';
            } else {
                warningAlert.style.display = 'none';
            }
        }

        // í•„í„° ì ìš© í•¨ìˆ˜
        function applyFilters() {
            const studentId = document.getElementById('studentFilter').value;
            const moodFilter = document.getElementById('moodFilter').value;
            const counselingFilter = document.getElementById('counselingFilter').value;
            const sortFilter = document.getElementById('sortFilter').value;

            let filteredData = getDataByDateRange(
                document.getElementById('startDate').value,
                document.getElementById('endDate').value
            );

            // í•™ìƒ í•„í„°
            if (studentId) {
                filteredData = filteredData.filter(item => item.studentId === studentId);
            }

            // ê°ì • í•„í„°
            if (moodFilter) {
                switch(moodFilter) {
                    case 'negative':
                        filteredData = filteredData.filter(item => item.mood <= 2);
                        break;
                    case 'neutral':
                        filteredData = filteredData.filter(item => item.mood === 3);
                        break;
                    case 'positive':
                        filteredData = filteredData.filter(item => item.mood >= 4);
                        break;
                }
            }

            // ìƒë‹´ ìš”ì²­ í•„í„°
            if (counselingFilter === 'true') {
                filteredData = filteredData.filter(item => item.counselingRequest);
            }

            // ì •ë ¬
            switch(sortFilter) {
                case 'date-desc':
                    filteredData.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                    break;
                case 'date-asc':
                    filteredData.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
                    break;
                case 'mood-desc':
                    filteredData.sort((a, b) => b.mood - a.mood);
                    break;
                case 'mood-asc':
                    filteredData.sort((a, b) => a.mood - b.mood);
                    break;
            }

            // ë°ì´í„° í‘œì‹œ ì—…ë°ì´íŠ¸
            updateDashboard(filteredData);
        }

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
        document.addEventListener('DOMContentLoaded', () => {
            initializeStudentFilter();
            
            // í•„í„° ë³€ê²½ ì´ë²¤íŠ¸
            ['studentFilter', 'moodFilter', 'counselingFilter', 'sortFilter'].forEach(id => {
                document.getElementById(id).addEventListener('change', applyFilters);
            });

            // í•™ìƒ ì„ íƒì‹œ í†µê³„ í‘œì‹œ
            document.getElementById('studentFilter').addEventListener('change', function() {
                if (this.value) {
                    showStudentStats(this.value);
                } else {
                    document.getElementById('studentStatsCard').style.display = 'none';
                }
            });

            // ìœ„í—˜ ì‹ í˜¸ ì£¼ê¸°ì  ì²´í¬ (1ì‹œê°„ë§ˆë‹¤)
            checkWarningSignals();
            setInterval(checkWarningSignals, 3600000);
        });
    </script>

    <style>
        /* í…Œì´ë¸” ìŠ¤íƒ€ì¼ ì¶”ê°€ */
        .table td {
            vertical-align: middle;
        }
        
        .table td:nth-child(3),
        .table td:nth-child(6) {
            max-width: 200px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
    </style>
</body>
</html> 